<?xml version="1.0" encoding="UTF-8"?>
<!--
  Example WSO2 MI API using State Tracker Mediator
  
  This demonstrates how to use the State Tracker Mediator in an API context
  to monitor request flow through different stages.
-->
<api context="/order" name="OrderAPI" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="POST" url-mapping="/create">
        <inSequence>
            
            <!-- Track API entry -->
            <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
                <property name="stateName" value="apiEntry"/>
                <property name="stateValue" expression="get-property('axis2', 'HTTP_METHOD')"/>
            </class>
            
            <!-- Track order validation -->
            <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
                <property name="stateName" value="orderValidation"/>
                <property name="stateValue" value="validating"/>
            </class>
            
            <!-- Validate order payload -->
            <log level="custom">
                <property name="message" value="Validating order"/>
            </log>
            
            <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
                <property name="stateName" value="orderValidation"/>
                <property name="stateValue" value="valid"/>
            </class>
            
            <!-- Track database operation -->
            <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
                <property name="stateName" value="dbOperation"/>
                <property name="stateValue" value="inserting"/>
            </class>
            
            <!-- Call database service -->
            <call>
                <endpoint>
                    <http method="post" uri-template="http://database-service/orders"/>
                </endpoint>
            </call>
            
            <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
                <property name="stateName" value="dbOperation"/>
                <property name="stateValue" value="success"/>
            </class>
            
            <!-- Track notification -->
            <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
                <property name="stateName" value="notification"/>
                <property name="stateValue" value="sending"/>
            </class>
            
            <!-- Send notification (async) -->
            <send>
                <endpoint>
                    <http method="post" uri-template="http://notification-service/send"/>
                </endpoint>
            </send>
            
        </inSequence>
        
        <outSequence>
            <!-- Track successful completion -->
            <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
                <property name="stateName" value="orderStatus"/>
                <property name="stateValue" value="created"/>
            </class>
            
            <log level="custom">
                <property name="message" value="Order created successfully"/>
            </log>
            
            <respond/>
        </outSequence>
        
        <faultSequence>
            <!-- Track failure -->
            <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
                <property name="stateName" value="orderStatus"/>
                <property name="stateValue" value="failed"/>
            </class>
            
            <log level="custom">
                <property name="message" value="Order creation failed"/>
                <property name="error" expression="get-property('ERROR_MESSAGE')"/>
            </log>
            
            <respond/>
        </faultSequence>
    </resource>
    
    <resource methods="GET" url-mapping="/status/*">
        <inSequence>
            <!-- Track status check request -->
            <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
                <property name="stateName" value="statusCheck"/>
                <property name="stateValue" value="initiated"/>
            </class>
            
            <!-- Get order ID from URL -->
            <property name="orderId" expression="get-property('uri.var.orderId')"/>
            
            <!-- Query database -->
            <call>
                <endpoint>
                    <http method="get" uri-template="http://database-service/orders/{uri.var.orderId}"/>
                </endpoint>
            </call>
            
            <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
                <property name="stateName" value="statusCheck"/>
                <property name="stateValue" value="completed"/>
            </class>
            
            <respond/>
        </inSequence>
    </resource>
</api>
