<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  Example WSO2 MI Sequence demonstrating the State Tracker Mediator
  
  This example shows how to use the State Tracker Mediator to track
  the state of a process flow through multiple steps.
-->
<sequence name="StateTrackingSequence" xmlns="http://ws.apache.org/ns/synapse">
    
    <!-- Track the start of the sequence -->
    <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
        <property name="stateName" value="sequenceStart"/>
        <property name="stateValue" value="initiated"/>
    </class>
    
    <!-- Log the initiation -->
    <log level="custom">
        <property name="Status" value="Sequence Started"/>
    </log>
    
    <!-- Step 1: Validate Request -->
    <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
        <property name="stateName" value="validation"/>
        <property name="stateValue" value="in-progress"/>
    </class>
    
    <!-- Your validation logic here -->
    <log level="custom">
        <property name="Status" value="Validating Request"/>
    </log>
    
    <!-- Mark validation as complete -->
    <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
        <property name="stateName" value="validation"/>
        <property name="stateValue" value="completed"/>
    </class>
    
    <!-- Step 2: Process Request -->
    <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
        <property name="stateName" value="processing"/>
        <property name="stateValue" value="started"/>
    </class>
    
    <!-- Your business logic here -->
    <log level="custom">
        <property name="Status" value="Processing Request"/>
    </log>
    
    <!-- Call backend service -->
    <call>
        <endpoint>
            <http method="post" uri-template="http://backend-service/api/process"/>
        </endpoint>
    </call>
    
    <!-- Mark processing as complete -->
    <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
        <property name="stateName" value="processing"/>
        <property name="stateValue" value="completed"/>
    </class>
    
    <!-- Step 3: Send Response -->
    <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
        <property name="stateName" value="response"/>
        <property name="stateValue" value="preparing"/>
    </class>
    
    <log level="custom">
        <property name="Status" value="Preparing Response"/>
    </log>
    
    <!-- Final state tracking -->
    <class name="org.wso2.carbon.mediator.statetracker.StateTrackerMediator">
        <property name="stateName" value="sequenceComplete"/>
        <property name="stateValue" value="success"/>
    </class>
    
    <respond/>
    
</sequence>
